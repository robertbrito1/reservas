{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&J - Terraza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-light">
    <div id="contenedor-todo" class="container text-center mt-4">
        <h1 class="brand-title">M&J</h1>
        <p class="brand-subtitle">Experiencia Gastron√≥mica & Reservas (TERRAZA)</p>
        <hr class="border-secondary opacity-25">

        <div id="btn-reserva-multiple" class="d-none mb-3">
            <button class="btn btn-success btn-lg w-100 shadow-lg fw-bold" onclick="abrirFormularioMultiple()">
                ‚úÖ RESERVAR GRUPO: <span id="lista-mesas-seleccionadas"></span>
            </button>
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6 col-lg-4">
                <form method="GET" id="form-filtros" class="bg-dark p-3 rounded shadow-sm">
                    <label class="form-label fw-bold text-white small">FECHA DE CONSULTA</label>
                    <input type="date" name="fecha" class="form-control mb-3" value="{{ fecha_actual }}" onchange="this.form.submit()">

                    <div class="btn-group w-100">
                        <button type="button" hx-get="?fecha={{ fecha_actual }}&turno=DIA" hx-target="#contenedor-todo" hx-select="#contenedor-todo" hx-swap="outerHTML"
                            class="btn btn-{% if turno_actual == 'DIA' %}primary{% else %}outline-light{% endif %}">‚òÄÔ∏è D√≠a</button>
                        <button type="button" hx-get="?fecha={{ fecha_actual }}&turno=NOCHE" hx-target="#contenedor-todo" hx-select="#contenedor-todo" hx-swap="outerHTML"
                            class="btn btn-{% if turno_actual == 'NOCHE' %}primary{% else %}outline-light{% endif %}">üåô Noche</button>
                    </div>
                    <input type="hidden" name="turno" value="{{ turno_actual }}">
                </form>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-2 mb-4">
            <a href="/" class="btn btn-outline-light">üè† SAL√ìN</a>
            <a href="/terraza/" class="btn btn-warning fw-bold">üå≥ TERRAZA</a>
        </div>

        <div class="restaurante-mapa">
            {% for mesa in mesas %}
                {% if mesa.ocupada %}
                    <div class="mesa-container mesa-ocupada {% if mesa.es_conjunto %}mesa-en-conjunto{% endif %}"
                         data-id="{{ mesa.detalle.id }}"
                         data-nombre="{{ mesa.detalle.nombre }}"
                         data-apellido="{{ mesa.detalle.apellido }}"
                         data-tel="{{ mesa.detalle.telefono }}"
                         data-hora="{{ mesa.detalle.hora|time:'H:i' }}"
                         data-coment="{{ mesa.detalle.comentarios|escapejs }}"
                         data-pax="{{ mesa.detalle.personas }}"
                         onclick="verDetalle(this)">
                {% else %}
                    <div class="mesa-container mesa-libre" id="mesa-{{ mesa.numero }}" onclick="toggleMesa('{{ mesa.numero }}')">
                {% endif %}
                    <span class="mesa-numero">T {{ mesa.numero }}</span>
                    <span class="mesa-estado">{% if mesa.ocupada %}{{ mesa.detalle.personas }}P {% if mesa.es_conjunto %}(G){% endif %}{% else %}Libre{% endif %}</span>
                </div>
            {% endfor %}
        </div>
        
        <div class="mt-4">
            <a href="{% url 'exportar_pdf' %}?fecha={{ fecha_actual }}&turno={{ turno_actual }}" class="btn btn-danger shadow">üì• Reporte PDF</a>
        </div>
    </div>

    <div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Reserva - Mesas: <span id="label_mesa"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'guardar_reserva' %}" method="POST">
                        {% csrf_token %}
                        <div class="row g-2 mb-2">
                            <div class="col-6"><input type="text" name="nombre" class="form-control" placeholder="Nombre" required></div>
                            <div class="col-6"><input type="text" name="apellido" class="form-control" placeholder="Apellido" required></div>
                        </div>
                        <input type="tel" name="telefono" class="form-control mb-2" placeholder="Tel√©fono" required>
                        <input type="number" name="personas" class="form-control mb-2" value="2" min="1">
                        <div class="row g-2 mb-2">
                            <div class="col-6"><input type="date" name="fecha" id="input_fecha" class="form-control" required></div>
                            <div class="col-6"><input type="time" name="hora" class="form-control" required></div>
                        </div>
                        <input type="hidden" id="input_mesa_numero" name="mesa">
                        <input type="hidden" name="turno" value="{{ turno_actual }}">
                        <textarea name="comentarios" class="form-control mb-3" rows="2" placeholder="Notas..."></textarea>
                        <button type="submit" class="btn btn-success w-100 fw-bold">Confirmar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning shadow-lg text-dark">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold">üìù Editar Reserva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                    <form id="form_editar" method="POST">
                        {% csrf_token %}
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="small fw-bold">Nombre</label>
                                <input type="text" name="nombre" id="edit_nombre" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">Apellido</label>
                                <input type="text" name="apellido" id="edit_apellido" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold">Tel√©fono</label>
                            <input type="tel" name="telefono" id="edit_tel" class="form-control" required>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="small fw-bold">Pax</label>
                                <input type="number" name="personas" id="edit_pax" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">Hora</label>
                                <input type="time" name="hora" id="edit_hora" class="form-control" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">Comentarios</label>
                            <textarea name="comentarios" id="edit_coment" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning fw-bold">üíæ Guardar Cambios</button>
                            <a id="btn_eliminar" href="#" class="btn btn-outline-danger btn-sm" onclick="return confirm('¬øLiberar mesa?')">üóëÔ∏è Eliminar Reserva</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let seleccionadas = [];

        function toggleMesa(num) {
            const idx = seleccionadas.indexOf(num);
            const el = document.getElementById('mesa-' + num);
            if (idx > -1) { 
                seleccionadas.splice(idx, 1); 
                el.classList.remove('mesa-seleccionada-temp'); 
            } else { 
                seleccionadas.push(num); 
                el.classList.add('mesa-seleccionada-temp'); 
            }
            const btn = document.getElementById('btn-reserva-multiple');
            btn.classList.toggle('d-none', seleccionadas.length === 0);
            document.getElementById('lista-mesas-seleccionadas').innerText = seleccionadas.join(', ');
        }

        function abrirFormularioMultiple() {
            document.getElementById('input_mesa_numero').value = seleccionadas.join(',');
            document.getElementById('label_mesa').innerText = seleccionadas.join(', ');
            document.getElementById('input_fecha').value = "{{ fecha_actual }}";
            new bootstrap.Modal(document.getElementById('modalReserva')).show();
        }

        function verDetalle(elemento) {
            const id = elemento.getAttribute('data-id');
            const n = elemento.getAttribute('data-nombre');
            const a = elemento.getAttribute('data-apellido');
            const t = elemento.getAttribute('data-tel');
            const h = elemento.getAttribute('data-hora');
            const c = elemento.getAttribute('data-coment');
            const p = elemento.getAttribute('data-pax');

            document.getElementById('form_editar').action = "/editar-reserva/" + id + "/";
            document.getElementById('edit_nombre').value = n;
            document.getElementById('edit_apellido').value = a;
            document.getElementById('edit_tel').value = t;
            document.getElementById('edit_hora').value = h;
            document.getElementById('edit_pax').value = p;
            document.getElementById('edit_coment').value = c;
            
            document.getElementById('btn_eliminar').href = "/eliminar-reserva/" + id + "/";
            new bootstrap.Modal(document.getElementById('modalDetalle')).show();
        }
    </script>
</body>
</html>