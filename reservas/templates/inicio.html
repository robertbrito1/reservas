{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&J - Panel de Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/estilos.css' %}">
</head>

<body class="bg-light">

    <div class="container text-center mt-4">
        <h1 class="brand-title">M&J</h1>
        <p class="brand-subtitle">Experiencia Gastron√≥mica & Reservas</p>
        <hr class="border-secondary opacity-25">

        <div class="row justify-content-center mb-4">
            <div class="col-md-6 col-lg-4">
                <form method="GET" id="form-filtros" class="bg-dark p-3 rounded shadow-sm">
                    <label class="form-label fw-bold text-white small">FECHA DE CONSULTA</label>
                    <input type="date" name="fecha" class="form-control mb-3" value="{{ fecha_actual }}" onchange="this.form.submit()">

                    <div class="btn-group w-100" role="group">
                        <a href="?fecha={{ fecha_actual }}&turno=DIA"
                            class="btn btn-{% if turno_actual == 'DIA' %}primary{% else %}outline-light{% endif %}">‚òÄÔ∏è D√≠a</a>
                        <a href="?fecha={{ fecha_actual }}&turno=NOCHE"
                            class="btn btn-{% if turno_actual == 'NOCHE' %}primary{% else %}outline-light{% endif %}">üåô Noche</a>
                    </div>
                    <input type="hidden" name="turno" value="{{ turno_actual }}">
                </form>
            </div>
        </div>

        <div class="restaurante-mapa">
            {% for mesa in mesas %}
                {% if mesa.ocupada %}
                    <div class="mesa-container mesa-ocupada"
                        onclick="verDetalle('{{ mesa.detalle.id }}', '{{ mesa.detalle.nombre }}', '{{ mesa.detalle.apellido }}', '{{ mesa.detalle.telefono }}', '{{ mesa.detalle.hora }}', '{{ mesa.detalle.comentarios|escapejs }}')">
                {% else %}
                    <div class="mesa-container mesa-libre" onclick="abrirFormulario('{{ mesa.numero }}')">
                {% endif %}
                    <span class="mesa-numero">{{ mesa.numero }}</span>
                    <span class="mesa-estado">{% if mesa.ocupada %}Ocupada{% else %}Libre{% endif %}</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Reserva - Mesa <span id="label_mesa"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                    <form action="{% url 'guardar_reserva' %}" method="POST">
                        {% csrf_token %}
                        <div class="row g-2">
                            <div class="col-6"><input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" required></div>
                            <div class="col-6"><input type="text" name="apellido" class="form-control mb-2" placeholder="Apellido" required></div>
                        </div>
                        <input type="tel" name="telefono" class="form-control mb-2" placeholder="Tel√©fono" required>
                        
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="small">Fecha:</label>
                                <input type="date" name="fecha" id="input_fecha" class="form-control" required>
                            </div>
                            <div class="col-6">
                                <label class="small">Hora:</label>
                                <input type="time" name="hora" class="form-control" required>
                            </div>
                        </div>

                        <label class="small">Turno:</label>
                        <select name="turno" id="input_turno" class="form-select mb-2">
                            <option value="DIA" {% if turno_actual == 'DIA' %}selected{% endif %}>D√≠a</option>
                            <option value="NOCHE" {% if turno_actual == 'NOCHE' %}selected{% endif %}>Noche</option>
                        </select>
                        
                        <input type="hidden" id="input_mesa_numero" name="mesa">
                        
                        <label class="small">Comentarios:</label>
                        <textarea name="comentarios" class="form-control mb-3" rows="2" placeholder="Opcional..."></textarea>
                        
                        <button type="submit" class="btn btn-success w-100">Confirmar Reserva</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Mesa Ocupada</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-1"><strong>Cliente:</strong></p>
                    <p id="det_nombre" class="text-uppercase"></p>
                    <p class="mb-1"><strong>Tel√©fono:</strong></p>
                    <p id="det_tel"></p>
                    <p class="mb-1"><strong>Hora:</strong></p>
                    <p id="det_hora"></p>
                    <div class="bg-light p-2 rounded">
                        <p class="mb-0 small"><strong>Notas:</strong></p>
                        <span id="det_comentarios" class="text-muted small italic"></span>
                    </div>
                    <hr>
                    <a id="btn_eliminar" href="#" class="btn btn-outline-danger btn-sm w-100"
                        onclick="return confirm('¬øCancelar esta reserva?')">üóëÔ∏è Liberar Mesa</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function verDetalle(id, nombre, apellido, tel, hora, comentarios) {
            document.getElementById('det_nombre').innerText = nombre + " " + apellido;
            document.getElementById('det_tel').innerText = tel;
            document.getElementById('det_hora').innerText = hora;
            document.getElementById('det_comentarios').innerText = comentarios || "Sin comentarios";
            document.getElementById('btn_eliminar').href = "/eliminar-reserva/" + id + "/";

            var modalDetalle = new bootstrap.Modal(document.getElementById('modalDetalle'));
            modalDetalle.show();
        }

        function abrirFormulario(numero) {
            document.getElementById('input_mesa_numero').value = numero;
            document.getElementById('label_mesa').innerText = numero;
            document.getElementById('input_fecha').value = "{{ fecha_actual }}";
            document.getElementById('input_turno').value = "{{ turno_actual }}";

            var miModal = new bootstrap.Modal(document.getElementById('modalReserva'));
            miModal.show();
        }
    </script>
</body>
</html>